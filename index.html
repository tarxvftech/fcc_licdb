<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenLayers Map with Points</title>
    <script src="https://cdn.jsdelivr.net/npm/ol@v10.2.1/dist/ol.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v10.2.1/ol.css">
    <style>
#map {
  width: 100%;
  height: 100vh;
}
    .ol-popup {
      position: absolute;
      background: white;
      padding: 10px;
      border-radius: 5px;
      border: 1px solid #ccc;
      box-shadow: 0 1px 4px rgba(0,0,0,0.2);
      min-width: 150px;
    }
    .layerbuttons {
      position: absolute;
      top: 1em;
      right: 1em;
      margin: 1em;
    }
    .layerbuttons button {
      width: auto;
    }
    </style>
  </head>
  <body>
    <div id="map"></div>
    <script>
      const osmLayer = new ol.layer.Tile({
        source: new ol.source.OSM(),
        visible: true 
      });

      const satelliteLayer = new ol.layer.Tile({
        source: new ol.source.XYZ({
          url: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
          attributions: 'Tiles Â© Esri'
        }),
        visible: false 
      });


      const map = new ol.Map({
        target: 'map',
        layers: [ osmLayer,satelliteLayer ],
        view: new ol.View({
          center: ol.proj.fromLonLat([-80, 40]),
          zoom: 7
        })
      });
      function switchLayer(layerToActivate) {
        osmLayer.setVisible(layerToActivate === 'osm');
        satelliteLayer.setVisible(layerToActivate === 'satellite');
      }
      // Add simple buttons to switch layers
      const buttonContainer = document.createElement('div');
      buttonContainer.className = 'ol-unselectable ol-control layerbuttons';
      buttonContainer.innerHTML = `
            <button onclick="switchLayer('osm')">OSM</button>
            <button onclick="switchLayer('satellite')">Satellite</button>
        `;
      map.addControl(new ol.control.Control({ element: buttonContainer }));

      // Load the JSON point data
      fetch('points.json')
        .then(response => response.json())
        .then(data => {
          const vectorSource = new ol.source.Vector({
            //features: new ol.format.GeoJSON().readFeatures(data)
            url: 'points.json',
            format: new ol.format.GeoJSON({
              dataProjection: 'EPSG:4326',  // GeoJSON projection
              featureProjection: 'EPSG:3857' // Map's projection (Web Mercator)
            })
          });
          const styles = {
            'Point': new ol.style.Style({
              image: new ol.style.Circle({
                radius: 5,
                fill: new ol.style.Fill({ color: 'red' }),
                stroke: new ol.style.Stroke({
                  color: 'black',
                  width: 1
                })
              }),
            }),
            'LineString': new ol.style.Style({
              stroke: new ol.style.Stroke({
                color: 'green',
                width: 1,
              }),
            }),
            'MultiLineString': new ol.style.Style({
              stroke: new ol.style.Stroke({
                color: 'green',
                width: 1,
              }),
            }),
            'MultiPoint': new ol.style.Style({
              image: new ol.style.Circle({
                radius: 5,
                fill: new ol.style.Fill({ color: 'red' }),
                stroke: new ol.style.Stroke({
                  color: 'black',
                  width: 1
                })
              }),
            }),
            'MultiPolygon': new ol.style.Style({
              stroke: new ol.style.Stroke({
                color: 'yellow',
                width: 1,
              }),
              fill: new ol.style.Fill({
                color: 'rgba(255, 255, 0, 0.1)',
              }),
            }),
            'Polygon': new ol.style.Style({
              stroke: new ol.style.Stroke({
                color: 'blue',
                lineDash: [4],
                width: 3,
              }),
              fill: new ol.style.Fill({
                color: 'rgba(0, 0, 255, 0.05)',
              }),
            }),
            'GeometryCollection': new ol.style.Style({
              stroke: new ol.style.Stroke({
                color: 'magenta',
                width: 2,
              }),
              fill: new ol.style.Fill({
                color: 'magenta',
              }),
              image: new ol.style.Circle({
                radius: 10,
                fill: null,
                stroke: new ol.style.Stroke({
                  color: 'magenta',
                }),
              }),
            }),
            'Circle': new ol.style.Style({
              stroke: new ol.style.Stroke({
                color: 'red',
                width: 2,
              }),
              fill: new ol.style.Fill({
                color: 'rgba(255,0,0,0.2)',
              }),
            }),
          };

          const styleFunction = function (feature, zoom) {
            const geometryType = feature.getGeometry().getType();
            const baseStyle = styles[geometryType];
            if (zoom >= 10) {
              const text = new ol.style.Text({
                font: '18px monospace',
                text: feature.get('call_sign'),
                offsetY: 0,
                offsetX: 10,
                textAlign: 'left',
                fill: new ol.style.Fill({ color: '#000' }),
              });
              return new ol.style.Style({
                image: baseStyle.getImage(),
                stroke: baseStyle.getStroke(),
                fill: baseStyle.getFill(),
                text: text,
              });
            }
            return baseStyle;
          };

          // Create a vector layer using the vector source and the style function
          const vectorLayer = new ol.layer.Vector({
            source: vectorSource,
            style: (feature) => styleFunction(feature, map.getView().getZoom())
          });


          map.addLayer(vectorLayer);


          const select = new ol.interaction.Select({
            multi: true,
          });
          map.addInteraction(select);

          const infoBox = document.createElement('div');
          infoBox.className = 'ol-popup';
          const infoOverlay = new ol.Overlay({
            element: infoBox,
            positioning: 'bottom-center',
            stopEvent: false,
            offset: [0, -15]
          });
          map.addOverlay(infoOverlay);

          select.on('select', (event) => {
            const selectedFeatures = event.selected;
            if (selectedFeatures.length > 0) {
              if( selectedFeatures.length > 1 ){
                console.log(selectedFeatures);
              }
              const feature = selectedFeatures[0];
              const coordinates = feature.getGeometry().getCoordinates();
              const properties = feature.getProperties();

              infoBox.innerHTML = `${properties.type}:<strong>${properties.call_sign}</strong><br><a href=${properties.link}>${properties.id}</a>`;
              if( coordinates.length == 2 ){
                infoOverlay.setPosition(coordinates);
              } else {
                infoOverlay.setPosition(coordinates[0][0]);
              }
            } else { //not selected, hide infobox
              infoOverlay.setPosition(undefined);
            }
          });
          map.getView().on('change:resolution', () => {

            vectorLayer.setStyle((feature) => styleFunction(feature, map.getView().getZoom()));
          });
        })
        .catch(error => console.error('Error loading JSON data:', error));
    </script>
  </body>
</html>
